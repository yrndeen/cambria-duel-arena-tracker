<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Statistics - Cambria Duel Arena Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
<script src="config.js"></script>
<script src="web3-utils.js"></script>
<style>
:root {
/* Red theme (default) */
--primary: #c62828;
--primary-light: #ff5f52;
--primary-dark: #8e0000;
--secondary: #ff5252;
--dark: #1a0f0f;
--dark-light: #2a1717;
--text: #f5f5f5;
--text-secondary: #b3b3b3;
--success: #00cc66;
--danger: #ff4d4d;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Roboto', sans-serif;
background-color: var(--dark);
color: var(--text);
line-height: 1.6;
}

.container {
max-width: 1200px;
margin: 0 auto;
padding: 0 20px;
}

header {
background: linear-gradient(to right, var(--primary-dark), var(--primary));
padding: 20px 0;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
position: sticky;
top: 0;
z-index: 100;
}

.header-content {
display: flex;
justify-content: space-between;
align-items: center;
}

.chain-toggle {
display: flex;
gap: 12px;
margin: 0 20px;
background: var(--dark-lighter);
padding: 6px;
border-radius: 12px;
border: 1px solid var(--border);
}

.chain-btn {
background: transparent;
border: none;
color: var(--text-secondary);
padding: 10px 18px;
border-radius: 8px;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
align-items: center;
gap: 8px;
font-size: 14px;
font-weight: 600;
position: relative;
overflow: hidden;
}

.chain-btn::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
opacity: 0;
transition: opacity 0.3s ease;
border-radius: 8px;
}

.chain-btn:hover::before {
opacity: 0.1;
}

.chain-btn:hover {
color: var(--text);
transform: translateY(-1px);
}

.chain-btn.active {
background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
color: white;
box-shadow: 0 4px 12px rgba(106, 61, 154, 0.3);
}

.chain-btn.active:hover {
transform: translateY(-2px);
box-shadow: 0 6px 16px rgba(106, 61, 154, 0.4);
}

.chain-btn.active::before {
opacity: 0;
}

.chain-icon {
font-size: 18px;
position: relative;
z-index: 1;
}

.chain-btn span:last-child {
position: relative;
z-index: 1;
}

.logo {
font-family: 'Orbitron', sans-serif;
font-size: 28px;
font-weight: 700;
display: flex;
align-items: center;
}

.logo-icon {
margin-right: 10px;
font-size: 32px;
}

nav ul {
display: flex;
list-style: none;
}

nav ul li {
margin-left: 25px;
}

nav ul li a {
color: var(--text);
text-decoration: none;
font-weight: 500;
transition: color 0.3s;
padding: 5px 10px;
border-radius: 4px;
}

nav ul li a:hover {
color: var(--secondary);
}

.hero {
text-align: center;
padding: 60px 0;
background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%234a2a75"/><path d="M0 0L100 100" stroke="%236a3d9a" stroke-width="2"/><path d="M100 0L0 100" stroke="%236a3d9a" stroke-width="2"/></svg>');
background-size: cover;
margin-bottom: 40px;
}

.hero h1 {
font-family: 'Orbitron', sans-serif;
font-size: 42px;
margin-bottom: 20px;
color: var(--secondary);
}

.hero p {
font-size: 18px;
max-width: 700px;
margin: 0 auto 30px;
color: var(--text-secondary);
}

.stats-overview {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 20px;
margin-bottom: 40px;
}

.stat-card {
background-color: var(--dark-light);
border-radius: 8px;
padding: 30px;
text-align: center;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
transition: transform 0.3s;
}

.stat-card:hover {
transform: translateY(-5px);
}

.stat-value {
font-size: 36px;
font-weight: 700;
margin: 10px 0;
font-family: 'Orbitron', sans-serif;
color: var(--secondary);
}

.stat-label {
font-size: 16px;
color: var(--text-secondary);
margin-bottom: 10px;
}

.charts-section {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 30px;
margin-bottom: 40px;
}

.chart-container {
background-color: var(--dark-light);
border-radius: 8px;
padding: 30px;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.chart-title {
font-family: 'Orbitron', sans-serif;
font-size: 20px;
margin-bottom: 20px;
color: var(--secondary);
text-align: center;
}

.insights-section {
background-color: var(--dark-light);
border-radius: 8px;
padding: 30px;
margin-bottom: 40px;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.insights-title {
font-family: 'Orbitron', sans-serif;
font-size: 24px;
margin-bottom: 20px;
color: var(--secondary);
}

.insight-item {
display: flex;
align-items: center;
padding: 15px 0;
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.insight-item:last-child {
border-bottom: none;
}

.insight-icon {
font-size: 24px;
margin-right: 15px;
}

.insight-text {
flex: 1;
}

.insight-value {
font-weight: 500;
color: var(--secondary);
}

.fee-info {
background-color: rgba(0, 180, 216, 0.1);
border: 1px solid var(--secondary);
border-radius: 8px;
padding: 15px;
margin: 20px 0;
font-size: 14px;
color: var(--text-secondary);
}

.fee-info strong {
color: var(--secondary);
}

footer {
background-color: var(--dark-light);
padding: 30px 0;
text-align: center;
margin-top: 60px;
}

.footer-content {
display: flex;
flex-direction: column;
align-items: center;
}

.social-links {
display: flex;
margin: 20px 0;
}

.social-links a {
display: flex;
align-items: center;
justify-content: center;
width: 40px;
height: 40px;
border-radius: 50%;
background-color: var(--primary);
color: white;
margin: 0 10px;
text-decoration: none;
transition: transform 0.3s;
}

.social-links a:hover {
transform: translateY(-3px);
}

@media (max-width: 768px) {
.header-content {
flex-direction: column;
}

nav ul {
margin-top: 20px;
}

.charts-section {
grid-template-columns: 1fr;
}

.stats-overview {
grid-template-columns: 1fr;
}
}
</style>
</head>
<body>
<header>
<div class="container">
<div class="header-content">
<div class="logo">
<span class="logo-icon">‚öîÔ∏è</span>
<span>Cambria Duel Tracker</span>
</div>

<div class="chain-toggle">
<button class="chain-btn active" data-chain="abstract" onclick="switchChain('abstract')">
<span class="chain-icon">üü¢</span>
<span>Abstract L2</span>
</button>
<button class="chain-btn" data-chain="ronin" onclick="switchChain('ronin')">
<span class="chain-icon">‚öîÔ∏è</span>
<span>Ronin</span>
</button>
</div>

<nav>
<ul>
<li><a href="index.html">Home</a></li>
<li><a href="leaderboard.html">Leaderboard</a></li>
<li><a href="statistics.html">Statistics</a></li>
<li><a href="about.html">About</a></li>
<li><a href="donate.html">Donate</a></li>
</ul>
</nav>
</div>
</div>
</header>

<section class="hero">
<div class="container">
<h1>Duel Arena Statistics</h1>
<p>Comprehensive analytics and insights from the Cambria Duel Arena ecosystem</p>
</div>
</section>

<main class="container">
<section class="stats-overview">
<div class="stat-card">
<div class="stat-label">Total Duels</div>
<div class="stat-value">12,847</div>
</div>
<div class="stat-card">
<div class="stat-label">Active Players</div>
<div class="stat-value">1,234</div>
</div>
<div class="stat-card">
<div class="stat-label">Total Volume</div>
<div class="stat-value">45.672 ETH</div>
</div>
<div class="stat-card">
<div class="stat-label">Total ETH Won</div>
<div class="stat-value">82.140 ETH</div>
</div>
<div class="stat-card">
<div class="stat-label">Average Duel Size</div>
<div class="stat-value">3.55 ETH</div>
</div>
</section>


<section class="charts-section">
<div class="chart-container">
<div class="chart-title">Duel Volume Over Time</div>
<canvas id="volumeChart"></canvas>
</div>
<div class="chart-container">
<div class="chart-title">Win Rate Distribution</div>
<canvas id="winRateChart"></canvas>
</div>
</section>

<section class="insights-section">
<h2 class="insights-title">Key Insights</h2>
<div class="insight-item">
<div class="insight-icon">üìà</div>
<div class="insight-text">
<div>Peak Activity Hours</div>
<div class="insight-value">2:00 PM - 4:00 PM UTC</div>
</div>
</div>
<div class="insight-item">
<div class="insight-icon">üéØ</div>
<div class="insight-text">
<div>Most Common Duel Amount</div>
<div class="insight-value">0.005 ETH (23% of all duels)</div>
</div>
</div>
<div class="insight-item">
<div class="insight-icon">üèÜ</div>
<div class="insight-text">
<div>Top Performer Win Rate</div>
<div class="insight-value">78.5% (0x329a7b10...e89c4)</div>
</div>
</div>
<div class="insight-item">
<div class="insight-icon">üí∞</div>
<div class="insight-text">
<div>Largest Single Duel</div>
<div class="insight-value">0.500 ETH (Duel #7234)</div>
</div>
</div>
<div class="insight-item">
<div class="insight-icon">‚ö°</div>
<div class="insight-text">
<div>Average Duel Duration</div>
<div class="insight-value">2.3 minutes</div>
</div>
</div>
</section>
</main>

<footer>
<div class="container">
<div class="footer-content">
<div class="logo">
<span class="logo-icon">‚öîÔ∏è</span>
<span>Cambria Duel Tracker</span>
</div>
<p>Track and analyze Cambria Duel Arena data on the Abstract L2 chain</p>
<div class="social-links">
<a href="#"><span>ùïè</span></a>
<a href="#"><span>ùêå</span></a>
<a href="#"><span>ùêÜ</span></a>
</div>
<p>¬© 2023 Cambria Duel Tracker. Not affiliated with @playcambria.</p>
</div>
</div>
</footer>

<script>
// Cambria Duel Arena Statistics - Smart Contract Integration
document.addEventListener('DOMContentLoaded', function() {
    // Load saved theme first
    loadSavedTheme();
    initializeStatistics();
});

async function initializeStatistics() {
    // Initialize Web3 in read-only mode
    try {
        const success = await window.cambriaWeb3.initialize();
        if (success) {
            console.log('Web3 initialized for statistics');
        }
    } catch (error) {
        console.log('Web3 initialization failed, using mock data:', error);
    }
    
    // Initialize charts
    initializeCharts();
    
    // Load initial data
    await loadStatisticsData();
    
    // Set up real-time updates
    setupRealTimeUpdates();
    
    // Listen for Web3 events
    window.cambriaWeb3.addEventListener('duelCompleted', handleDuelCompleted);
}

function initializeCharts() {
    // Volume Chart
    const volumeCtx = document.getElementById('volumeChart').getContext('2d');
    window.volumeChart = new Chart(volumeCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct'],
            datasets: [{
                label: 'Volume (ETH)',
                data: [3.200, 4.100, 3.800, 5.200, 4.800, 6.100, 5.900, 6.700, 7.200, 6.800],
                borderColor: '#6a3d9a',
                backgroundColor: 'rgba(106, 61, 154, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: {
                        color: '#f5f5f5'
                    }
                }
            },
            scales: {
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#f5f5f5'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#f5f5f5'
                    }
                }
            }
        }
    });

    // Win Rate Distribution Chart
    const winRateCtx = document.getElementById('winRateChart').getContext('2d');
    window.winRateChart = new Chart(winRateCtx, {
        type: 'doughnut',
        data: {
            labels: ['40-50%', '50-60%', '60-70%', '70-80%', '80%+'],
            datasets: [{
                data: [15, 35, 30, 15, 5],
                backgroundColor: [
                    '#ff4d4d',
                    '#ff8c00',
                    '#ffd700',
                    '#00cc66',
                    '#00b4d8'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: {
                        color: '#f5f5f5'
                    }
                }
            }
        }
    });
}

async function loadStatisticsData() {
    try {
        setLoadingState(true);
        
        let statsData;
        
        // Try to get data from smart contracts first
        if (window.cambriaWeb3.isConnected) {
            statsData = await window.cambriaWeb3.getEcosystemStats();
        } else {
            // Fallback to mock data
            statsData = getMockStatisticsData();
        }
        
        updateStatisticsDisplay(statsData);
        
    } catch (error) {
        console.error('Error loading statistics data:', error);
        // Fallback to mock data
        const mockData = getMockStatisticsData();
        updateStatisticsDisplay(mockData);
        window.cambriaWeb3.showError('Failed to load live data. Showing cached data.');
    } finally {
        setLoadingState(false);
    }
}

function getMockStatisticsData() {
    return {
        totalDuels: 1247,
        activePlayers: 89,
        totalVolume: 45.672,
        totalETHWon: 82.140,
        averageDuelSize: 3.55,
        mostCommonDuelAmount: 0.005,
        largestSingleDuel: 0.500,
        totalFees: 4.567,
        averageWinRate: 58.3,
        winRateDistribution: {
            '40-50%': 15,
            '50-60%': 35,
            '60-70%': 30,
            '70-80%': 15,
            '80%+': 5
        },
        volumeHistory: [3.200, 4.100, 3.800, 5.200, 4.800, 6.100, 5.900, 6.700, 7.200, 6.800]
    };
}

function updateStatisticsDisplay(data) {
    // Update stat cards
    document.querySelector('.stat-card:nth-child(1) .stat-value').textContent = data.totalDuels.toLocaleString();
    document.querySelector('.stat-card:nth-child(2) .stat-value').textContent = data.activePlayers.toLocaleString();
    document.querySelector('.stat-card:nth-child(3) .stat-value').textContent = `${data.totalVolume.toFixed(3)} ETH`;
    document.querySelector('.stat-card:nth-child(4) .stat-value').textContent = `${data.totalETHWon.toFixed(3)} ETH`;
    document.querySelector('.stat-card:nth-child(5) .stat-value').textContent = `${data.averageDuelSize.toFixed(3)} ETH`;
    document.querySelector('.stat-card:nth-child(6) .stat-value').textContent = `${data.mostCommonDuelAmount.toFixed(3)} ETH`;
    document.querySelector('.stat-card:nth-child(7) .stat-value').textContent = `${data.largestSingleDuel.toFixed(3)} ETH`;
    
    // Update charts
    updateVolumeChart(data.volumeHistory);
    updateWinRateChart(data.winRateDistribution);
}

function updateVolumeChart(volumeData) {
    if (window.volumeChart) {
        window.volumeChart.data.datasets[0].data = volumeData;
        window.volumeChart.update();
    }
}

function updateWinRateChart(distributionData) {
    if (window.winRateChart) {
        const labels = Object.keys(distributionData);
        const data = Object.values(distributionData);
        
        window.winRateChart.data.labels = labels;
        window.winRateChart.data.datasets[0].data = data;
        window.winRateChart.update();
    }
}

function setupRealTimeUpdates() {
    // Set up periodic data refresh
    setInterval(async () => {
        if (window.cambriaWeb3.isConnected) {
            try {
                await loadStatisticsData();
            } catch (error) {
                console.error('Real-time update failed:', error);
            }
        }
    }, CONFIG.UI.REFRESH_INTERVAL);
}

function handleDuelCompleted(data) {
    console.log('Duel completed, refreshing statistics:', data);
    
    // Refresh statistics after a short delay
    setTimeout(async () => {
        await loadStatisticsData();
    }, 2000);
}

function setLoadingState(isLoading) {
    const statCards = document.querySelectorAll('.stat-card');
    const charts = document.querySelectorAll('.chart-container');
    
    if (isLoading) {
        statCards.forEach(card => card.classList.add('loading'));
        charts.forEach(chart => chart.classList.add('loading'));
    } else {
        statCards.forEach(card => card.classList.remove('loading'));
        charts.forEach(chart => chart.classList.remove('loading'));
    }
}

// Add loading styles
const style = document.createElement('style');
style.textContent = `
    .stat-card.loading,
    .chart-container.loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .stat-card.loading::after,
    .chart-container.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid var(--secondary);
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);

// Chain switching functionality
function switchChain(chain) {
    if (CONFIG.switchChain(chain)) {
        // Update UI
        document.querySelectorAll('.chain-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-chain="${chain}"]`).classList.add('active');
        
        // Update web3 connection
        if (window.cambriaWeb3) {
            window.cambriaWeb3.updateChainConfig();
        }
        
        // Update chain-specific text
        updateChainSpecificText();
        
        // Refresh data
        if (typeof loadStatisticsData === 'function') {
            loadStatisticsData();
        }
        
        // Show notification
        showNotification(`Switched to ${CONFIG.getCurrentChain().CHAIN_NAME}`, 'success');
    }
}

// Load saved theme on page load
function loadSavedTheme() {
    if (CONFIG.loadTheme()) {
        // Update UI to reflect saved theme
        document.querySelectorAll('.chain-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-chain="${CONFIG.ACTIVE_CHAIN}"]`).classList.add('active');
        
        // Update chain-specific text
        updateChainSpecificText();
    }
}

// Update chain-specific text throughout the page
function updateChainSpecificText() {
    const currentChain = CONFIG.getCurrentChain();
    const chainName = currentChain.CHAIN_NAME;
    
    // Update page title
    const pageTitle = document.querySelector('h1');
    if (pageTitle) {
        pageTitle.textContent = `Statistics - ${chainName}`;
    }
    
    // Update transaction link text
    const txLinks = document.querySelectorAll('.tx-link');
    txLinks.forEach(link => {
        link.textContent = `üîó View Transaction on ${chainName}`;
    });
}

// Show notification
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    // Style the notification
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--primary);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 1000;
        font-weight: 500;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}
</script>
</body>
</html>